<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Creative Uploader – Clickzone Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg: #f6f8fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 12px 30px rgba(15, 23, 42, 0.08);

      --accent: #10b981;
      --accent2:#34d399;
      --danger:#dc2626;
      --ok:#16a34a;

      --r: 16px;
      --r2: 12px;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
    }

    .container {
      max-width: 760px;
      margin: 40px auto;
      background: var(--card);
      border-radius: var(--r);
      padding: 22px 26px 26px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .topband{
      margin: -22px -26px 18px;
      padding: 16px 26px;
      background: linear-gradient(90deg, rgba(16,185,129,.12), rgba(16,185,129,.05), rgba(255,255,255,1));
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .topband .left{
      display:flex; align-items:center; gap: 12px;
      min-width: 0;
    }
    .chip{
      width: 42px; height: 42px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(16,185,129,.22), rgba(16,185,129,.08));
      border: 1px solid rgba(16,185,129,.25);
      display:flex; align-items:center; justify-content:center;
      flex: 0 0 auto;
    }
    .headline{ min-width: 0; }
    h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.01em;
      font-weight: 800;
    }
    p.subtitle {
      margin: 3px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .step-card{
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 16px;
      background:#fff;
      box-shadow: 0 6px 18px rgba(15,23,42,.05);
    }

    /* Seçim sonrası bu kart "kilitli" görünür (Meta review için bile tek marka hissi verir) */
    .step-locked{
      opacity: .55;
      pointer-events: none;
      filter: grayscale(.15);
    }

    /* Form üstünde SADECE marka adı */
    .brand-header{
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: var(--r);
      background: #fff;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
      margin: 18px 0 14px;
    }
    .brand-title{
      font-weight: 900;
      letter-spacing: -0.2px;
      font-size: 16px;
    }

    form { margin-top: 10px; }

    .field { margin-bottom: 14px; }

    label {
      display: block;
      font-weight: 650;
      margin-bottom: 6px;
      font-size: 13px;
      color: #111827;
    }

    select,
    input[type="text"],
    input[type="file"] {
      width: 100%;
      padding: 10px 10px;
      border-radius: var(--r2);
      border: 1px solid var(--border);
      font-size: 14px;
      box-sizing: border-box;
      background:#fff;
      color: var(--text);
    }

    select:focus,
    input[type="text"]:focus,
    input[type="file"]:focus {
      outline: none;
      border-color: rgba(16,185,129,.60);
      box-shadow: 0 0 0 4px rgba(16,185,129, 0.14);
    }

    .row {
      display: flex;
      gap: 12px;
    }
    .row > .field { flex: 1; }

    .helper {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 6px;
      line-height: 1.35;
    }

    .source-type-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 13px;
    }
    .source-type-group label {
      font-weight: 520;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      color: #111827;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #fff;
      user-select:none;
    }
    .source-type-group input[type="radio"] { transform: scale(1.08); }

    .btnrow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(16,185,129,.35);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      background: var(--accent);
      color: #ffffff;
      transition: .15s ease;
    }
    button:hover { background: var(--accent2); }
    button:disabled { opacity: 0.55; cursor: default; }

    .ghost {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .ghost:hover { border-color: rgba(16,185,129,.35); background:#fff; }

    .status {
      margin-top: 14px;
      font-size: 13px;
      min-height: 18px;
    }
    .status.ok { color: var(--ok); }
    .status.error { color: var(--danger); }

    pre {
      margin-top: 14px;
      background: #0b1120;
      color: #e5e7eb;
      padding: 14px 16px;
      border-radius: 12px;
      font-size: 12px;
      overflow-x: auto;
      border: 1px solid rgba(255,255,255,.06);
    }

    .tag-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      font-size: 11px;
      color: #6b7280;
      flex-wrap: wrap;
    }
    .tag {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px dashed #d4d4d8;
      background: #fff;
    }

    .hidden { display: none; }

    @media (max-width: 600px) {
      .container { margin: 16px; padding: 18px 16px 22px; }
      .topband{ margin: -18px -16px 16px; padding: 14px 16px; }
      .row { flex-direction: column; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topband">
      <div class="left">
        <div class="chip">☁️</div>
        <div class="headline">
          <h1>Creative Uploader</h1>
          <p class="subtitle">
            Marka seç → kaynak belirle → Meta + Drive yükle.
          </p>
        </div>
      </div>
      <!-- Meta review için marka değiştirme hissi yok: sadece genel sıfırla -->
      <button type="button" class="ghost" id="resetAllBtn">Sıfırla</button>
    </div>

    <!-- STEP 1: Sadece Marka seçimi -->
    <div id="brandStep" class="step-card">
      <div class="field" style="margin-bottom:12px;">
        <label for="brand">Marka</label>
        <select id="brand" name="brand" required>
          <option value="" selected>Marka seçiniz…</option>
          <option value="bella">Bella Maison</option>
          <option value="desa">DESA</option>
        </select>
        <div class="helper">Not: Meta incelemesi için marka seçildikten sonra arayüz tek marka odaklı görünür.</div>
      </div>

      <div class="btnrow">
        <button type="button" id="continueBtn">Devam →</button>
      </div>
    </div>

    <!-- STEP 2: Marka seçilince aşağıda açılan içerik -->
    <div id="mainStep" class="hidden">
      <!-- ÜSTTE SADECE MARKA ADI -->
      <div class="brand-header" id="brandHeader">
        <div class="brand-title" id="brandTitle">—</div>
      </div>

      <form id="uploadForm">
        <div class="row">
          <div class="field">
            <label for="type">Medya tipi</label>
            <select id="type" name="type" required>
              <option value="image">Görsel (Image)</option>
              <option value="video">Video</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>Kaynak türü</label>
          <div class="source-type-group">
            <label>
              <input type="radio" name="sourceType" value="url" checked />
              URL'den getir
            </label>
            <label>
              <input type="radio" name="sourceType" value="upload" />
              Bilgisayardan yükle
            </label>
            <label>
              <input type="radio" name="sourceType" value="drive" />
              Google Drive URL
            </label>
          </div>
          <div class="helper">
            Drive seçeneğinde paylaşıma açık bir dosya linki (share link) kullanmalısın.
          </div>
        </div>

        <!-- URL alanı -->
        <div class="field" id="field-source-url">
          <label for="sourceUrl">Kaynak URL</label>
          <input type="text" id="sourceUrl" name="sourceUrl" placeholder="https://cdn.siten.com/path/to/file.jpg" />
          <div class="helper">
            CDN / web site URL’si. Backend bu dosyayı indirip hem Meta’ya hem Drive’a gönderecek.
          </div>
        </div>

        <!-- Bilgisayardan upload alanı -->
        <div class="field hidden" id="field-file-upload">
          <label for="fileInput">Bilgisayardan dosya seç</label>
          <input type="file" id="fileInput" name="fileInput" accept="image/*,video/*" />
          <div class="helper">
            Büyük dosyalarda test için daha küçük dosya ile denemek iyi olur.
          </div>
        </div>

        <!-- Google Drive URL alanı -->
        <div class="field hidden" id="field-drive-url">
          <label for="driveUrl">Google Drive URL</label>
          <input type="text" id="driveUrl" name="driveUrl" placeholder="https://drive.google.com/file/d/..." />
          <div class="helper">
            Paylaşıma açık bir Google Drive dosya linki gir. Backend bu URL üzerinden indirip işlem yapar.
          </div>
        </div>

        <div class="field">
          <label for="fileName">Dosya adı (opsiyonel)</label>
          <input type="text" id="fileName" name="fileName" placeholder="BM_SS24_Look1_Story.jpg" />
        </div>

        <div class="btnrow">
          <button type="submit" id="submitBtn">Yüklemeyi Başlat</button>
        </div>

        <div class="tag-row">
          <div class="tag">Meta Ads API</div>
          <div class="tag">Google Drive API</div>
          <div class="tag">URL / Local / Drive</div>
        </div>

        <div id="status" class="status"></div>
        <pre id="result" style="display:none;"></pre>
      </form>
    </div>
  </div>

  <script>
    const brandSelect = document.getElementById('brand');
    const brandStep = document.getElementById('brandStep');
    const mainStep = document.getElementById('mainStep');
    const brandTitle = document.getElementById('brandTitle');
    const brandHeader = document.getElementById('brandHeader');

    const continueBtn = document.getElementById('continueBtn');
    const resetAllBtn = document.getElementById('resetAllBtn');

    const form = document.getElementById('uploadForm');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const submitBtn = document.getElementById('submitBtn');

    const fieldSourceUrl = document.getElementById('field-source-url');
    const fieldFileUpload = document.getElementById('field-file-upload');
    const fieldDriveUrl = document.getElementById('field-drive-url');
    const fileInput = document.getElementById('fileInput');

    function brandLabel(v){
      if (v === 'bella') return 'Bella Maison';
      if (v === 'desa') return 'DESA';
      return '—';
    }

    function getSourceType() {
      const checked = document.querySelector('input[name="sourceType"]:checked');
      return checked ? checked.value : 'url';
    }

    function updateSourceFields() {
      const sourceType = getSourceType();
      fieldSourceUrl.classList.toggle('hidden', sourceType !== 'url');
      fieldFileUpload.classList.toggle('hidden', sourceType !== 'upload');
      fieldDriveUrl.classList.toggle('hidden', sourceType !== 'drive');
    }

    document.querySelectorAll('input[name="sourceType"]').forEach((el) => {
      el.addEventListener('change', updateSourceFields);
    });
    updateSourceFields();

    // Marka seçince: marka step kilitlenir + form açılır + aşağı scroll
    continueBtn.addEventListener('click', () => {
      const v = brandSelect.value;
      if (!v) { alert('Lütfen önce marka seç.'); return; }

      brandTitle.textContent = brandLabel(v);

      // Meta review: marka seçimi artık "değiştirilebilir" gibi görünmesin
      brandStep.classList.add('step-locked');

      // form alanlarını aç
      mainStep.classList.remove('hidden');

      // aşağı doğru kaydır
      setTimeout(() => {
        brandHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 50);
    });

    // Tam sıfırlama: marka dahil her şeyi resetle (UI'da "switch" hissi yok)
    resetAllBtn.addEventListener('click', () => {
      brandSelect.value = '';
      brandTitle.textContent = '—';

      brandStep.classList.remove('step-locked');
      mainStep.classList.add('hidden');

      statusEl.textContent = '';
      statusEl.className = 'status';
      resultEl.style.display = 'none';
      resultEl.textContent = '';

      document.getElementById('type').value = 'image';
      document.querySelector('input[name="sourceType"][value="url"]').checked = true;
      document.getElementById('sourceUrl').value = '';
      document.getElementById('driveUrl').value = '';
      document.getElementById('fileName').value = '';
      fileInput.value = '';
      updateSourceFields();

      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    async function callApi(payload) {
      const res = await fetch('/api/upload-creative', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const json = await res.json();
      return { res, json };
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      statusEl.textContent = '';
      statusEl.className = 'status';
      resultEl.style.display = 'none';
      resultEl.textContent = '';

      const brand = brandSelect.value;
      const type = document.getElementById('type').value;
      const sourceType = getSourceType();
      const sourceUrl = document.getElementById('sourceUrl').value.trim();
      const driveUrl = document.getElementById('driveUrl').value.trim();
      const fileNameInput = document.getElementById('fileName').value.trim();

      if (!brand) {
        statusEl.textContent = 'Lütfen marka seç.';
        statusEl.classList.add('error');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      }

      if (sourceType === 'url' && !sourceUrl) {
        statusEl.textContent = 'Lütfen geçerli bir kaynak URL gir.';
        statusEl.classList.add('error');
        return;
      }
      if (sourceType === 'drive' && !driveUrl) {
        statusEl.textContent = 'Lütfen geçerli bir Google Drive URL gir.';
        statusEl.classList.add('error');
        return;
      }
      if (sourceType === 'upload' && (!fileInput.files || fileInput.files.length === 0)) {
        statusEl.textContent = 'Lütfen bilgisayarından bir dosya seç.';
        statusEl.classList.add('error');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Yükleniyor...';

      try {
        if (sourceType === 'upload') {
          const file = fileInput.files[0];
          const reader = new FileReader();

          reader.onload = async () => {
            try {
              const result = reader.result;
              const [, base64] = result.split(',');
              const fileMimeType = file.type || 'application/octet-stream';
              const finalFileName = fileNameInput || file.name || `${brand}_${Date.now()}`;

              const payload = {
                brand, type, sourceType,
                fileName: finalFileName,
                fileBase64: base64,
                fileMimeType,
              };

              const { res, json } = await callApi(payload);

              if (!res.ok || !json.ok) {
                statusEl.textContent = 'Hata oluştu: ' + (json.error || ('HTTP ' + res.status));
                statusEl.classList.add('error');
              } else {
                statusEl.textContent = 'Yükleme başarılı ✔️';
                statusEl.classList.add('ok');
                resultEl.style.display = 'block';
                resultEl.textContent = JSON.stringify(json, null, 2);
              }
            } catch (err) {
              statusEl.textContent = 'Beklenmeyen hata: ' + err.message;
              statusEl.classList.add('error');
            } finally {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Yüklemeyi Başlat';
            }
          };

          reader.onerror = () => {
            statusEl.textContent = 'Dosya okunurken hata oluştu.';
            statusEl.classList.add('error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Yüklemeyi Başlat';
          };

          reader.readAsDataURL(file);
        } else {
          const payload = { brand, type, sourceType };
          if (fileNameInput) payload.fileName = fileNameInput;
          if (sourceType === 'url') payload.sourceUrl = sourceUrl;
          if (sourceType === 'drive') payload.driveUrl = driveUrl;

          const { res, json } = await callApi(payload);

          if (!res.ok || !json.ok) {
            statusEl.textContent = 'Hata oluştu: ' + (json.error || ('HTTP ' + res.status));
            statusEl.classList.add('error');
          } else {
            statusEl.textContent = 'Yükleme başarılı ✔️';
            statusEl.classList.add('ok');
            resultEl.style.display = 'block';
            resultEl.textContent = JSON.stringify(json, null, 2);
          }

          submitBtn.disabled = false;
          submitBtn.textContent = 'Yüklemeyi Başlat';
        }
      } catch (err) {
        statusEl.textContent = 'Beklenmeyen hata: ' + err.message;
        statusEl.classList.add('error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Yüklemeyi Başlat';
      }
    });
  </script>
</body>
</html>
